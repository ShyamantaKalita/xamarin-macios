#!/bin/groovy

def isPr = (env.ghprbPullId && !env.ghprbPullId.empty ? true : false)
def branchName = (isPr ? ("pr" + env.ghprbPullId) : env.BRANCH_NAME)
def gitHash = null
def xiPackageUrl = null
def xmPackageUrl = null
def utils = null

def xiPackageFilename = null
def xmPackageFilename = null

timestamps {
    node('felix-sierra') {
        dir('xamarin-macios') {
            stage('checkout') {
                scmVars = checkout scm
                sh('env')
                sh('pwd')
                sh('ls -la')
                sh('./jenkins/build-package.sh')
                utils = load "./jenkins/utils.groovy"
                xiPackageFileName = findFiles (glob: "../package/xamarin.ios-*.pkg")[0].name
                xmPackageFileName = findFiles (glob: "../package/xamarin.mac-*.pkg")[0].name
            }
            stage('Signing') {
                echo "Signing ${xiPackageFilename}"
                withCredentials([string(credentialsId: 'codesign_keychain_pw', variable: 'CODESIGN_KEYCHAIN_PASSWORD')]) {
                    sh "security unlock-keychain -p $CODESIGN_KEYCHAIN_PASSWORD"
                    sh "/usr/bin/productsign -s 'Developer ID Installer: Xamarin Inc' '../package/${xiPackageFilename}' '../package/${xiPackageFilename}-signed.pkg'"
                    sh "/usr/sbin/spctl -vvv --assess --type install '../package/${xiPackageFilename}-signed.pkg'"
                }
                sh "mv ../package/${xiPackageFilename}-signed.pkg .../package/${xiPackageFilename}"
                echo "Signing ${xmPackageFilename}"
                withCredentials([string(credentialsId: 'codesign_keychain_pw', variable: 'CODESIGN_KEYCHAIN_PASSWORD')]) {
                    sh "security unlock-keychain -p $CODESIGN_KEYCHAIN_PASSWORD"
                    sh "/usr/bin/productsign -s 'Developer ID Installer: Xamarin Inc' '../package/${xmPackageFilename}' '../package/${xmPackageFilename}-signed.pkg'"
                    sh "/usr/sbin/spctl -vvv --assess --type install '../package/${xmPackageFilename}-signed.pkg'"
                }
                sh "mv ../package/${xmPackageFilename}-signed.pkg .../package/${xmPackageFilename}"
            }
            stage('report status') {
                gitHash = (isPr ? (env.ghprbActualCommit) : scmVars.GIT_COMMIT)
                xiPackageUrl = "http://bosstoragemirror.blob.core.windows.net/wrench/jenkins/${branchName}/${gitHash}/${env.BUILD_NUMBER}/package/${xiPackageFilename}"
                xiPackageUrl = "http://bosstoragemirror.blob.core.windows.net/wrench/jenkins/${branchName}/${gitHash}/${env.BUILD_NUMBER}/package/${xmPackageFilename}"
                utils.reportGitHubStatus (gitHash, 'jenkins-PKG-Xamarin.iOS', "${xiPackageUrl}", 'SUCCESS', "${xiPackageFilename}")
                utils.reportGitHubStatus (gitHash, 'jenkins-PKG-Xamarin.Mac', "${xmPackageUrl}", 'SUCCESS', "${xmPackageFilename}")
            }
        }
    }
}
