#!/bin/groovy

def isPr = (env.ghprbPullId && !env.ghprbPullId.empty ? true : false)
def branchName = (isPr ? ("pr" + env.ghprbPullId) : env.BRANCH_NAME)
def gitHash = null
def xiPackageUrl = null
def xmPackageUrl = null
def utils = null

def xiPackageFilename = null
def xmPackageFilename = null

timestamps {
    node('felix-sierra') {
        dir('xamarin-macios') {
            stage('Checkout') {
                scmVars = checkout scm
                sh('env')
                sh('pwd')
                sh('ls -la')
                sh('./jenkins/build-package.sh')
                utils = load "./jenkins/utils.groovy"
                sh('ls -la ..')
                sh('ls -la ../package')
            }
        }
        stage('Signing') {
            def p = findFiles (glob: "package/xamarin.ios-*.pkg")
            echo "p: ${p}"
            echo "p[0]: " + p[0]
            echo "p[0].name: " + p[0].name

            xiPackageFilename = findFiles (glob: "package/xamarin.ios-*.pkg")[0].name
            xmPackageFilename = findFiles (glob: "package/xamarin.mac-*.pkg")[0].name
            sh('ls -la .')
            sh('ls -la package')
            echo "Found xi: ${xiPackageFilename} xm: ${xmPackageFilename}"
            utils.signPackage ("package", "${xiPackageFilename}")
            utils.signPackage ("package", "${xmPackageFilename}")
        }
        stage('Report GitHub Status') {
            gitHash = (isPr ? (env.ghprbActualCommit) : scmVars.GIT_COMMIT)
            xiPackageUrl = "https://dl.internalx.com/wrench/jenkins/${branchName}/${gitHash}/${env.BUILD_NUMBER}/package/${xiPackageFilename}"
            xmPackageUrl = "https://dl.internalx.com/wrench/jenkins/${branchName}/${gitHash}/${env.BUILD_NUMBER}/package/${xmPackageFilename}"
            utils.reportGitHubStatus (gitHash, 'jenkins-PKG-Xamarin.iOS', "${xiPackageUrl}", 'SUCCESS', "${xiPackageFilename}")
            utils.reportGitHubStatus (gitHash, 'jenkins-PKG-Xamarin.Mac', "${xmPackageUrl}", 'SUCCESS', "${xmPackageFilename}")
        }
    }
}

